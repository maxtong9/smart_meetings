<p id="notice"><%= notice %></p>
<link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">
<div class="container-fluid">
  <h1> <%= @meeting.name %> </h1>

  <a class="a-style" style="margin: 0 40px"><%= link_to 'Edit', edit_meeting_path(@meeting) %> |
  <%= link_to 'Back', meetings_path %> </a>

  <div class="row" style="margin: 0 60px">

    <!-- Participants card -->
    <div class="col-sm-4 .col-sm-2 mb-5">
      <div class="card border-left-primary shadow h-100 py-1">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Participants</div>
              <div class="h5 mb-2 text-gray" style="font-size:15px"><%= @meeting.participants %></div>
            </div>
            <div class="col-auto">
              <i class="fas fa-calendar fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Audio files card -->
    <% audio_files = "" %>
    <div class="col-sm-4 .col-sm-2 mb-5" stlye="font-family: 'Nunito', sans-serif;">
      <div class="card border-left-success shadow h-100 py-1">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2" style="text_align: center">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1" style="color:#5cdb95;">Attached Files</div>
              <% if @meeting.file.attachments.first != nil %>
                  <% for i in 0..@meeting.participants-1 do %>
                        <% audio_files = audio_files+@meeting.file.attachments[i].filename.to_s()+ ' ' %>
                  <% end %>
                  <div class="h5 mb-2 text-gray" style="font-size:15px"> <%= audio_files %></div>
              <% else %>
                  <div class="h5 mb-2 text-gray-400">No Attached Files</div>
                  <%= render 'upload_form', meeting: @meeting %>
              <% end %>
            </div>
            <div class="col-auto">
              <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

<% if @meeting.file.attachments.first != nil %>
    <% json_from_file = File.read("tmp/" + @meeting.file.attachments.last.filename.to_s()) %>
    <% hash = JSON.parse(json_from_file, object_class: OpenStruct) %>

    <% participants = [] %>
    <div class="card shadow mb-4" style="margin: 0 30px 0 75px">
        <div class="card-header py-2" stlye="font-family: 'Nunito', sans-serif;">
           <h6 class="m-0 font-weight-bold text-primary">Summary</h6>
        </div>
        <div class="card-body">
            <% temp = 0 %>
            <% p = 0 %>
            <% string_s = '' %>
            <% for i in hash.summary %>
                <% if temp == 0 %>
                  <% string_s = i[1][0...-1] %>
                  <% p = i[0] %>
                  <% temp = temp+1 %>
                <% else %>
                  <% if p == i[0] %>
                    <% string_s = string_s+ ' ' + i[1][0...-1] %>
                    <% if temp == hash.summary.length-1 %>
                      <p> <%= p[0...-1] %>: <%=string_s%></p>
                      <% if (participants.include? p[0...-1].to_s())== false  %>
                        <% participants.append(p[0...-1]) %>
                      <%end%>
                    <% end %>
                  <% else %>
                    <p> <%= p[0...-1] %>: <%=string_s%></p>
                    <% if (participants.include? p[0...-1].to_s()) == false %>
                      <% participants.append(p[0...-1]) %>
                    <%end%>
                    <% string_s = i[1][0...-1] %>
                    <% p = i[0] %>
                  <% end %>
                  <% temp = temp+1 %>
                <% end %>

            <% end %>

          </div>
      </div>

      <div class="row" style="margin: 0 20px 0 60px">
        <div class="col-xl-6 col-lg-4">
          <div class="card border-left-primary shadow mb-4">
              <div class="card-header py-3 align-items-center">
                <h6 class="m-0 font-weight-bold text-primary" stlye="font-family: 'Nunito', sans-serif;">Questions</h6>
              </div>
              <div class="card-body">
               <% if hash.questions.length != 0 %>
                 <% for i in hash.questions %>
                    <ul> <li class="li-style"><%= i[0] %>: <%= i[1]%> </li> </ul>
                 <% end %>
               <% else %>
                 <p> No questions were asked during the meeting. </p>
               <% end %>
               </div>
        </div>
       </div>
       <div class="col-xl-6 col-lg-4">
         <div class="card border-left-success shadow mb-4">
             <div class="card-header py-3 align-items-center">
               <h6 class="m-0 font-weight-bold text-primary" stlye="font-family: 'Nunito', sans-serif;">Speaker Percentage</h6>
             </div>
             <div class="card-body">
             <div class="chart-area">
               <canvas id="speaker_chart"></canvas>
             </div>
           </div>
         </div>
       </div>
     </div>

     <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
     <script type="text/javascript">
       var ctx = document.getElementById('speaker_chart').getContext('2d');
       var myDoughnutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
      				datasets: [{
      					data: [5, 8, 1, 3, 7],
      					backgroundColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 206, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 159, 64, 1)'
      					],
      					label: 'Dataset 1'
      				}],
      				labels: [
      					'Red',
      					'Blue',
      					'Yellow',
      					'Green',
      					'Purple'
      				]
      			},
      			options: {
      				responsive: true,
      				legend: {
      					position: 'right',
      				},
      				animation: {
      					animateScale: true,
      					animateRotate: true
      				}
      			}
        });

    </script>

     <% action_counter = {} %>
     <div class="row" style="margin: 0 20px 0 60px">
       <div class="col-xl-6 col-lg-4">
         <div class="card border-left-primary shadow mb-4">
             <div class="card-header py-3 align-items-center">
               <h6 class="m-0 font-weight-bold text-primary" stlye="font-family: 'Nunito', sans-serif;">Action Items</h6>
             </div>
             <div class="card-body">
               <% if hash.action_items.length != 0 %>
                 <% for i in hash.action_items %>
                   <% if action_counter.include? i[0] %>
                     <% action_counter[i[0]] += 1 %>
                   <% else %>
                     <% action_counter[i[0]] = 1 %>
                   <% end %>
                   <ul> <li class="li-style"> <%= i[0] %>: <%= i[1][0...-1]%> </li> </ul>
                 <% end %>
               <% else %>
                 <p> No action items were said during the meeting. </p>
               <% end %>
           </div>
         </div>
       </div>
       <% action_data = [] %>
       <% action_participants = [] %>
       <% for key in action_counter %>
        <% action_data.push(key[1]) %>
        <% action_participants.push(key[0]) %>
       <% end %>

       <div class="col-xl-6 col-lg-4">
         <div class="card border-left-success shadow mb-4">
             <div class="card-header py-3 align-items-center">
               <h6 class="m-0 font-weight-bold text-primary" stlye="font-family: 'Nunito', sans-serif;">Action Items Frequency</h6>
             </div>
             <div class="card-body">
             <div class="chart-area">
               <canvas id="action_chart"></canvas>
             </div>
           </div>
         </div>
       </div>
     </div>

     <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
     <script type="text/javascript">
        var ctx1 = document.getElementById('action_chart').getContext('2d');
        var chart = new Chart(ctx1, {
          type: 'doughnut',
          data: {
            datasets: [{
              data: <%= raw action_data %>,
              backgroundColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
              ],
              label: 'Dataset 1'
            }],
            labels: <%= raw action_participants %>
          },
          options: {
            responsive: true,
            legend: {
              position: 'right',
            },
            animation: {
              animateScale: true,
              animateRotate: true
            }
          }
        });
    </script>

    <% hesitation_counter = {} %>
    <% if hash.hesitation_analytics.length != 0 %>
      <% for i in hash.hesitation_analytics %>
        <% hesitation_counter[i[0]] = i[1] %>
      <% end %>
    <% else %>
      <p> None </p>
    <% end %>

    <% hesitation_array = [] %>
    <% for i in participants %>
      <% hesitation_array.append(hesitation_counter[i])%>
    <% end %>

    <% interruption_counter = {} %>
    <% if hash.interruption.to_s.length != 0 %>
      <% for i in hash.hesitation_analytics %>
        <% interruption_counter[i[0]] = i[1] %>
      <% end %>
    <% else %>
      <p> None </p>
    <% end %>

    <% interruption_array = [] %>
    <% for i in participants %>
      <% interruption_array.append(interruption_counter[i])%>
    <% end %>

    <div class="row" style="margin: 0 20px 0 60px">
      <div class="col-xl-6 col-lg-4">
        <div class="card border-left-primary shadow mb-4">
            <div class="card-header py-3 align-items-center">
              <h6 class="m-0 font-weight-bold text-primary" stlye="font-family: 'Nunito', sans-serif;">Hesitations</h6>
            </div>
            <div class="card-body">
            <div class="chart-area">
              <canvas id="hesitation_chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-6 col-lg-4">
        <div class="card border-left-success shadow mb-4">
            <div class="card-header py-3 align-items-center">
              <h6 class="m-0 font-weight-bold text-primary" stlye="font-family: 'Nunito', sans-serif;">Interruptions</h6>
            </div>
            <div class="card-body">
            <div class="chart-area">
              <canvas id="interruption_chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script type="text/javascript">
    // var ctx = document.getElementById('myChart').getContext('2d');
    var ctx = document.getElementById('hesitation_chart').getContext('2d');
    var ctx1 = document.getElementById('interruption_chart').getContext('2d');
    var participants = <%=raw participants%>;
    var hesitation_chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: participants,
            datasets: [{
                label: '# of Hesitations',
                data: <%=raw hesitation_array%>,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        max: <%=raw hesitation_array[0] * 4 %>
                    }
                }]
            }
        }
      });
      var interruption_chart = new Chart(ctx1, {
          type: 'bar',
          data: {
              labels: participants,
              datasets: [{
                  label: '# of Interruptions',
                  data: <%=raw interruption_array%>,
                  backgroundColor: [
                      'rgba(255, 99, 132, 0.2)',
                      'rgba(54, 162, 235, 0.2)',
                      'rgba(255, 206, 86, 0.2)',
                      'rgba(75, 192, 192, 0.2)',
                      'rgba(153, 102, 255, 0.2)',
                      'rgba(255, 159, 64, 0.2)'
                  ],
                  borderColor: [
                      'rgba(255, 99, 132, 1)',
                      'rgba(54, 162, 235, 1)',
                      'rgba(255, 206, 86, 1)',
                      'rgba(75, 192, 192, 1)',
                      'rgba(153, 102, 255, 1)',
                      'rgba(255, 159, 64, 1)'
                  ],
                  borderWidth: 1
              }]
          },
          options: {
              scales: {
                  yAxes: [{
                      ticks: {
                          beginAtZero: true,
                          max: <%=raw interruption_array[0] * 4 %>
                      }
                  }]
              }
          }
        });
    </script>

    <div class="card shadow mb-4" style="margin: 0 30px 0 75px">
        <div class="card-header py-2" stlye="font-family: 'Nunito', sans-serif;">
           <h6 class="m-0 font-weight-bold text-primary">Transcription</h6>
        </div>
        <div class="card-body">
          <% temp1 = 0 %>
          <% p1 = '' %>
          <% string1 = '' %>
          <% time1 = 0 %>
          <% time2 = 0 %>
          <% for i in hash.raw %>
              <% if temp1 == 0 %>
                <% string1 = i[1] %>
                <% p1 = i[0] %>
                <% temp1 = temp1+1 %>
                <% time1 = i[2] %>
                <% time2 = i[3] %>
              <% else %>
                <% if p1 == i[0] %>
                  <% string1 = string1+i[1] %>
                  <% time2 = i[3] %>
                  <% if temp1 == hash.raw.length-1 %>
                    <p><%= p1[0...-1]%> (<%= time1 %>, <%= time2 %>): <%=string1%></p>
                    <% string1 = '' %>
                  <% end %>
                <% else %>
                  <p><%= p1[0...-1]%> (<%= time1 %>, <%= time2 %>): <%=string1%></p>
                  <% string1 = '' %>
                  <% string1 = i[1] %>
                  <% p1 = i[0] %>
                  <% time1 = i[2] %>
                  <% time2 = i[3] %>
                <% end %>
                <% temp1 = temp1+1 %>
              <% end %>

          <% end %>
        </div>
    </div>
<% end %>

</div>
